# Улучшенная версия 2248 бота

## Обзор

Этот проект представляет собой значительно улучшенную версию 2248 бота с обучением и адаптацией стратегии. Все улучшения были реализованы с сохранением внешнего API, чтобы обеспечить обратную совместимость с существующим кодом.

## Основные улучшения

### 1. GameRunner
- **Обучение на основе эпизодов**: Введена система обучения, где бот анализирует успешность предыдущих игр и адаптирует стратегию
- **Динамическая адаптация профилей**: Бот выбирает профиль из `optimal_orders.json` на основе текущего состояния игры
- **Улучшенная обработка сигналов**: Добавлена корректная обработка `SIGINT` с сохранением состояния
- **Система событий**: Введена очередь событий для более надёжной обработки игровых ситуаций

### 2. GameLogic
- **Адаптивная оценка цепочек**: Метод `find_best_chain_smart` теперь использует обученные веса для оценки
- **Система профилей**: Добавлена логика выбора профиля на основе текущего состояния игры
- **История ходов**: Введена система отслеживания успешности различных стратегий

### 3. AdDetector
- **Обучение на основе результатов**: Адаптивное поведение при обнаружении рекламы в зависимости от предыдущих успешных/неуспешных попыток
- **Улучшенное распознавание**: Использование машинного обучения для более точного определения рекламы

### 4. ScreenProcessor
- **Улучшенная обработка ошибок**: Более надёжное распознавание доски с резервными методами
- **Кэширование**: Введено кэширование результатов для повышения производительности

### 5. Новые компоненты

#### EventSystem
Централизованная система событий для координации между модулями:
- Поддержка различных типов событий (GAME_START, GAME_END, BOARD_RECOGNIZED и др.)
- Подписка и отписка обработчиков событий
- История событий с возможностью сохранения

#### LearningEngine
Модуль для самообучения и адаптации стратегии:
- Система эпизодического обучения на основе результатов игр
- Адаптивные веса для оценки цепочек
- Статистика эффективности различных профилей
- Сохранение и загрузка модели обучения

#### GameStateTracker
Отслеживание состояния игры и статистики:
- Отслеживание всех аспектов игрового процесса
- Статистика по профилям и стратегиям
- История игровых сессий
- Рекомендации по выбору профилей

## Структура файлов

```
/workspace/
├── event_system.py           # Система событий
├── learning_engine.py        # Движок обучения
├── game_state_tracker.py     # Отслеживание состояния игры
├── game_runner_enhanced.py   # Улучшенный GameRunner
├── game_logic_enhanced.py    # Улучшенный GameLogic
├── ad_detector_enhanced.py   # Улучшенный AdDetector
├── screen_processor_enhanced.py # Улучшенный ScreenProcessor
├── main_enhanced.py          # Главный модуль интеграции
└── README_enhanced.md        # Документация
```

## Использование

Для запуска улучшенной версии бота:

```bash
python main_enhanced.py
```

Для запуска с параметрами:

```bash
# Запуск улучшенной версии с 200 ходами
python main_enhanced.py --max-moves 200

# Запуск оригинальной версии для сравнения
python main_enhanced.py --original

# Показ статистики после игры
python main_enhanced.py --stats
```

## Сохранение API

Все улучшения были реализованы с сохранением внешнего API:
- Все основные классы и методы остались с теми же именами и сигнатурами
- Система событий интегрирована без изменения публичного API
- Форматы `config.json` и `optimal_orders.json` сохранены
- Основные алгоритмы поиска цепочек и оценки остались без изменений
- Взаимодействие с ADB и распознавание доски не изменены

## Сохранение логики игры

- Основные алгоритмы поиска цепочек и оценки остались без изменений
- Взаимодействие с ADB и распознавание доски не изменены
- Логика обработки рекламы сохранена, но улучшена

## Возможности обучения

Бот теперь способен:
- Анализировать эффективность различных стратегий
- Адаптировать веса для оценки цепочек на основе результатов
- Выбирать оптимальные профили на основе текущего состояния игры
- Сохранять и восстанавливать состояние обучения
- Обновлять статистику профилей в `optimal_orders.json`

## Система событий

Все модули теперь могут взаимодействовать через систему событий:
- `GAME_START` - начало новой игры
- `GAME_END` - завершение игры
- `BOARD_RECOGNIZED` - распознавание доски
- `CHAIN_FOUND` - найдена цепочка
- `MOVE_EXECUTED` - выполнен ход
- `AD_DETECTED` - обнаружена реклама
- `AD_HANDLED` - реклама обработана
- `ERROR_OCCURRED` - ошибка
- `STRATEGY_CHANGED` - изменение стратегии
- `PROFILE_SELECTED` - выбор профиля
- `LEARNING_UPDATE` - обновление обучения
- `STOP_REQUESTED` - запрос остановки

## Сохранение состояния

Все компоненты сохраняют свое состояние в файлы:
- `learning_model.pkl` - модель обучения
- `learning_episodes.json` - эпизоды обучения
- `game_stats.json` - статистика игр
- `events_history.json` - история событий

## Улучшения производительности

- Кэширование результатов распознавания
- Адаптивные пороги для улучшения точности
- Оптимизированные алгоритмы обработки
- Улучшенная обработка ошибок с механизмами повтора

## Безопасность и надежность

- Корректная обработка сигналов прерывания
- Сохранение состояния при аварийном завершении
- Механизмы повтора для ADB команд
- Защита от бесконечных циклов